<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Compras Online</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root { --bg-color: #212121; --card-color: #2c2c2c; --text-color: #f0f0f0; --secondary-text-color: #a0a0a0; --primary-color: #ffc107; --green-highlight: #4CAF50; --danger-color: #f44336; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; position: sticky; top: 0; z-index: 10; background-color: var(--bg-color); border-bottom: 1px solid #383838; }
        .header .title { font-size: 1.25rem; font-weight: bold; position: absolute; left: 50%; transform: translateX(-50%); }
        .header .title i { margin-right: 8px; color: var(--primary-color); }
        #save-status { font-size: 0.8rem; color: var(--secondary-text-color); transition: opacity 0.5s; opacity: 0; }
        #save-status.show { opacity: 1; }
        .container { padding: 16px; }
        .shopping-list-table { width: 100%; border-collapse: collapse; }
        .shopping-list-table th, .shopping-list-table td { padding: 12px 8px; text-align: left; border-bottom: 1px solid #383838; vertical-align: middle; }
        .item-name-input { width: 100%; background: none; border: none; color: var(--text-color); font-size: 1rem; resize: none; overflow-y: hidden; }
        .action-btn { background: none; border: none; color: var(--danger-color); cursor: pointer; font-size: 1.2rem; }
        .action-btn.add { color: var(--green-highlight); }
        .price-cell input { width: 100%; text-align: right; background-color: transparent; color: var(--text-color); border: none; padding: 8px; }
        .purchased .item-name-input { text-decoration: line-through; color: var(--secondary-text-color); }
    </style>
</head>
<body>
    <div class="header">
        <span id="save-status"></span>
        <span class="title"><i class="fas fa-shopping-cart"></i>Lista Online</span>
    </div>
    <div class="container">
        <table class="shopping-list-table">
            <thead>
                <tr>
                    <th style="width: 40px;"><i class="fas fa-check"></i></th>
                    <th>Item</th>
                    <th style="width: 80px;">Preço 1</th>
                    <th style="width: 80px;">Preço 2</th>
                    <th style="width: 45px;"></th>
                </tr>
            </thead>
            <tbody id="shopping-list-body"></tbody>
        </table>
    </div>
    <script>
        const tableBody = document.getElementById('shopping-list-body');
        const saveStatus = document.getElementById('save-status');
        let saveTimeout;
        function showStatus(message, isError = false) {
            saveStatus.textContent = message;
            saveStatus.style.color = isError ? 'var(--danger-color)' : 'var(--secondary-text-color)';
            saveStatus.classList.add('show');
            setTimeout(() => saveStatus.classList.remove('show'), 3000);
        }
        function debounce(func, delay) {
            return function(...args) {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => func.apply(this, args), delay);
            };
        }
        async function saveListOnline() {
            showStatus('Salvando...');
            const items = [];
            document.querySelectorAll('#shopping-list-body tr:not(.add-item-row)').forEach(row => {
                items.push({
                    name: row.cells[1].querySelector('textarea').value.trim(),
                    priceShibata: row.cells[2].querySelector('input').value,
                    priceNagumo: row.cells[3].querySelector('input').value,
                    purchased: row.classList.contains('purchased')
                });
            });
            try {
                const response = await fetch('/api/list', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(items)
                });
                if (!response.ok) throw new Error('Falha ao salvar.');
                showStatus('Salvo na nuvem!');
            } catch (error) {
                showStatus('Erro ao salvar!', true);
            }
        }
        const debouncedSave = debounce(saveListOnline, 1000);
        async function loadListOnline() {
            showStatus('Carregando...');
            try {
                const response = await fetch('/api/list');
                if (!response.ok) throw new Error('Falha ao buscar dados.');
                const items = await response.json();
                tableBody.innerHTML = '';
                if (items && items.length > 0) items.forEach(buildItemRow);
                showStatus('Lista carregada.', false);
            } catch (error) {
                showStatus('Erro ao carregar!', true);
            } finally {
                createAddItemRow();
            }
        }
        tableBody.addEventListener('input', (event) => {
            if (event.target.tagName.toLowerCase() === 'textarea') autoResizeTextarea(event.target);
            debouncedSave();
        });
        tableBody.addEventListener('change', debouncedSave);
        tableBody.addEventListener('blur', debouncedSave, true);
        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }
        function createAddItemRow() {
            document.querySelector('.add-item-row')?.remove();
            const newRow = tableBody.insertRow(-1);
            newRow.classList.add('add-item-row');
            newRow.innerHTML = `
                <td></td>
                <td><textarea id="newItemName" class="item-name-input" placeholder="Adicionar novo item..." rows="1"></textarea></td>
                <td class="price-cell"><input type="text" placeholder="R$ 0,00"></td>
                <td class="price-cell"><input type="text" placeholder="R$ 0,00"></td>
                <td><button class="action-btn add" onclick="commitItem()"><i class="fas fa-plus"></i></button></td>
            `;
            const newItemInput = document.getElementById('newItemName');
            newItemInput.focus();
            newItemInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    commitItem();
                }
            });
        }
        function commitItem() {
            const addItemRow = document.querySelector('.add-item-row');
            if (!addItemRow) return;
            const itemName = addItemRow.querySelector('textarea').value.trim();
            if (itemName === '') return;
            const priceInputs = addItemRow.querySelectorAll('input');
            buildItemRow({ name: itemName, priceShibata: priceInputs[0].value, priceNagumo: priceInputs[1].value, purchased: false });
            addItemRow.remove();
            createAddItemRow();
            debouncedSave();
        }
        function buildItemRow(itemData) {
            const newRow = tableBody.insertRow(tableBody.rows.length - 1);
            if (itemData.purchased) newRow.classList.add('purchased');
            newRow.innerHTML = `
                <td><input type="checkbox" onchange="togglePurchased(this)" ${itemData.purchased ? 'checked' : ''}></td>
                <td><textarea class="item-name-input" rows="1">${itemData.name}</textarea></td>
                <td class="price-cell"><input type="text" value="${itemData.priceShibata || 'R$ 0,00'}"></td>
                <td class="price-cell"><input type="text" value="${itemData.priceNagumo || 'R$ 0,00'}"></td>
                <td><button class="action-btn" onclick="removeItem(this)"><i class="fas fa-trash-alt"></i></button></td>
            `;
            autoResizeTextarea(newRow.querySelector('textarea'));
        }
        function removeItem(button) {
            if (confirm('Remover este item?')) {
                button.closest('tr').remove();
                debouncedSave();
            }
        }
        function togglePurchased(checkbox) {
            checkbox.closest('tr').classList.toggle('purchased', checkbox.checked);
            debouncedSave();
        }
        document.addEventListener('DOMContentLoaded', loadListOnline);
    </script>
</body>
</html>
