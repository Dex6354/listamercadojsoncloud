<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Mercado</title>

    <link rel="manifest" href="./manifest.json"> 

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Meu Mercado">
    <link rel="apple-touch-icon" href="01.png">

    <meta property="og:title" content="Meu Mercado" />
    <meta property="og:type" content="website" />
    <meta property="og:description" content="Sua lista de compras inteligente com comparador de preços e otimização." />
    <meta property="og:image" content="https://meumercado.pages.dev/01.png" />


    <link rel="icon" href="01.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        :root {
            --bg-color: #212121;
            --card-color: #2c2c2c;
            --text-color: #f0f0f0;
            --secondary-text-color: #a0a0a0;
            --primary-color: #ffc107;
            --green-highlight: #4CAF50;
            --danger-color: #f44336;
            --yellow-sync-color: #ffc107;
            --border-radius: 12px;
            --input-bg-color: #383838;
            --menu-width: 250px;
        }

        *, *::before, *::after { box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        /* --- TELA DE LOGIN --- */
        #auth-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .auth-box {
            background-color: var(--card-color);
            padding: 30px;
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        .auth-box h2 {
            color: var(--primary-color);
            margin-bottom: 25px;
        }
        .auth-input {
            width: 100%;
            padding: 12px;
            background-color: var(--input-bg-color);
            border: 1px solid #444;
            border-radius: 8px;
            color: var(--text-color);
            font-size: 1rem;
            margin-bottom: 15px;
        }
        .password-container {
            position: relative;
            margin-bottom: 15px;
        }
        .password-container .auth-input {
            margin-bottom: 0;
            padding-right: 40px; /* Espaço para o ícone */
        }
        #togglePassword {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: var(--secondary-text-color);
        }
        .auth-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .auth-buttons .custom-btn {
            flex-grow: 1;
        }
        #auth-message {
            color: var(--danger-color);
            min-height: 20px;
            margin-top: 15px;
            font-size: 0.9rem;
        }

        /* Ocultar app-container por padrão */
        #app-container {
            display: none;
        }

        /* --- HEADER --- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid var(--input-bg-color);
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: var(--bg-color);
        }
        .header .title img {
            height: 30px;
            width: auto;
            margin-right: 10px;
            border-radius: 5px;
        }
        .header .menu-icon { font-size: 1.5rem; cursor: pointer; color: var(--primary-color); padding: 5px; }
        .header .title { font-size: 1.25rem; font-weight: bold; display: flex; align-items: center; white-space: nowrap; position: absolute; left: 50%; transform: translateX(-50%); }
        .header .title i { margin-right: 8px; color: var(--primary-color); }

        /* --- SIDE MENU & OVERLAY --- */
        .side-menu { height: 100%; width: 0; position: fixed; z-index: 1001; top: 0; left: 0; background-color: var(--card-color); overflow-x: hidden; transition: 0.3s; padding-top: 60px; box-shadow: 2px 0 10px rgba(0,0,0,0.5); }
        .side-menu.open { width: var(--menu-width); }
        .side-menu .close-btn { position: absolute; top: 15px; right: 25px; font-size: 2rem; color: var(--primary-color); cursor: pointer; line-height: 1; }
        .side-menu a { padding: 15px 20px; text-decoration: none; font-size: 1.1rem; color: var(--text-color); display: block; transition: 0.3s; border-bottom: 1px solid var(--input-bg-color); }
        .side-menu a:hover { background-color: #575757; color: var(--primary-color); }
        .side-menu a i { color: var(--primary-color); width: 20px; text-align: center; margin-right: 10px; }
        #page-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 1000; display: none; transition: opacity 0.3s; }
        #page-overlay.show { display: block; }

        /* --- CONTEÚDO PRINCIPAL --- */
        .container {
            padding: 0;
            max-width: 100%;
            margin: 0;
            flex-grow: 1;
        }

        .section {
            background-color: var(--card-color);
            padding: 20px 16px;
            border-radius: var(--border-radius);
            margin: 0 0 24px 0;
        }

        .shopping-list-section {
            padding: 0;
            border-radius: 0;
        }

        .shopping-list-section .section-header { padding: 20px 16px 16px 16px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .section-header h2 { margin: 0; font-size: 1.5rem; color: var(--primary-color); }
        .section-header .clear-btn { background: none; border: none; color: var(--danger-color); cursor: pointer; font-size: 1.2rem; transition: color 0.3s; padding: 5px; }
        .section-header .clear-btn:hover { color: #ff7961; }

        /* --- BOTÕES --- */
        .custom-btn { background-color: var(--primary-color); color: var(--bg-color); border: none; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: bold; padding: 10px 15px; transition: background-color 0.3s; }
        .custom-btn:hover { background-color: #ffd54f; }
        .custom-btn.secondary { background-color: var(--input-bg-color); color: var(--text-color); }
        .custom-btn.secondary:hover { background-color: #555; }
        .button-group { display: flex; gap: 10px; }
        .button-group .custom-btn, .button-group a { border-radius: 8px; }

        /* --- TABELA E PREÇOS --- */
        .table-scroll-wrapper { overflow-x: auto; width: 100%; }
        .shopping-list-table { width: auto; min-width: 100%; border-collapse: collapse; table-layout: fixed; }
        .shopping-list-table th, .shopping-list-table td { padding: 12px 8px; text-align: left; border-bottom: 1px solid #4a4a4a; vertical-align: middle; }
        .shopping-list-table th { font-size: 0.8rem; color: var(--secondary-text-color); text-transform: uppercase; }
        .shopping-list-table th:first-child, .shopping-list-table td:first-child { padding-left: 16px; }
        .shopping-list-table th:last-child, .shopping-list-table td:last-child { padding-right: 16px; }
        .price-cell { padding: 0 !important; width: 80px; text-align: right; }
        .price-cell input { width: 100%; padding: 12px 8px; text-align: right; background-color: var(--card-color); color: var(--text-color); border: none; border-radius: 0 !important; }
        .price-cell input.default-price { color: var(--secondary-text-color) !important; }
        .price-cell:first-of-type { border-right: 1px solid var(--input-bg-color); }
        .item-name-input { width: 100%; background: none; border: none; color: var(--text-color); font-size: 1rem; font-family: inherit; padding: 4px 0; border-radius: 4px; resize: none; overflow-y: hidden; line-height: 1.4; transition: all 0.2s ease-in-out; }
        .item-name-input:focus { outline: none; background-color: var(--input-bg-color); }
        .shopping-list-table .action-btn { background: none; border: none; color: var(--danger-color); cursor: pointer; font-size: 1.2rem; transition: color 0.3s; padding: 0; }
        .shopping-list-table .action-btn:hover { color: #ff7961; }
        .shopping-list-table .action-btn.add { color: var(--green-highlight); }
        .shopping-list-table .action-btn.add:hover { color: #81c784; }
        .cheapest-price { color: var(--green-highlight) !important; font-weight: bold; }
        .cheapest-price::before { content: "✔ "; }
        .equal-price { color: var(--primary-color) !important; font-weight: bold; }
        .shopping-list-table td input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        .purchased .item-name-input, .purchased input[type="text"] { text-decoration: line-through; color: var(--secondary-text-color); }

        /* --- SEÇÃO DO EMBED --- */
        .iframe-container { position: relative; border-radius: var(--border-radius); overflow: hidden; padding-top: 200%; }
        .iframe-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }
        #iframe-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); display: none; justify-content: center; align-items: center; flex-direction: column; gap: 15px; z-index: 5; color: var(--text-color); text-align: center; }
        .loader { border: 4px solid var(--input-bg-color); border-top: 4px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #comparator-section { padding-top: 0; padding-bottom: 0; margin-bottom: 24px; }
        .collapsible-header { cursor: pointer; padding: 20px 16px; display: flex; justify-content: space-between; align-items: center; }
        .collapsible-header h2 { margin: 0; font-size: 1.5rem; color: var(--primary-color); }
        .collapsible-header .fas.fa-chevron-down { transition: transform 0.3s ease; color: var(--secondary-text-color); }
        .collapsible-header.active .fas.fa-chevron-down { transform: rotate(180deg); }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; padding: 0 16px; }
        .collapsible-content.expanded { max-height: 100vh; padding-bottom: 20px; }
        .footer { text-align: center; padding: 16px; color: var(--secondary-text-color); font-size: 0.875rem; background-color: #282828; margin-top: auto; width: 100%; }
        #sync-status-indicator { width: 12px; height: 12px; border-radius: 50%; background-color: var(--green-highlight); z-index: 11; transition: background-color 0.5s ease; flex-shrink: 0; }
        .header-right { display: flex; align-items: center; gap: 15px; }
        #username-display { color: var(--secondary-text-color); font-size: 0.9rem; display: flex; align-items: center; gap: 8px; }
        #sync-status-indicator.status-syncing { background-color: var(--yellow-sync-color); }
        #sync-status-indicator.status-error { background-color: var(--danger-color); }
        #sync-status-indicator.status-saved { background-color: var(--green-highlight); }
        #sync-status-indicator.status-offline { background-color: #7986cb; } 
        /* --- Autocomplete --- */ 
        #autocomplete-suggestions { position: absolute; background-color: var(--input-bg-color); border: 1px solid var(--primary-color); border-top: none; border-radius: 0 0 8px 8px; z-index: 1002; /* Mais alto que o overlay do menu */ max-height: 200px; overflow-y: auto; display: none; box-shadow: 0 4px 8px rgba(0,0,0,0.2); } 
        .suggestion-item { padding: 8px; cursor: pointer; color: var(--text-color); } 
        .suggestion-item:hover { background-color: #555; }
    </style>
</head>
<body>
    <div id="page-overlay"></div>
    <div id="side-menu" class="side-menu">
        <a href="javascript:void(0)" class="close-btn" onclick="closeMenu()">&times;</a>
        <a href="#" onclick="showSection('list')"><i class="fas fa-list-ul"></i> Minha Lista</a>
        <a href="#" onclick="showSection('comparator')"><i class="fas fa-balance-scale"></i> Comparador</a>
        <a href="#" onclick="showSection('config')"><i class="fas fa-cogs"></i> Configurações</a>
        <a href="#" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i> Sair</a>
    </div>

    <div id="auth-container">
        <div class="auth-box">
            <h2>Bem-vindo(a)</h2>
            <input type="email" id="email" class="auth-input" placeholder="E-mail" required>
            <div class="password-container">
                <input type="password" id="password" class="auth-input" placeholder="Senha" required>
                <i class="fas fa-eye" id="togglePassword"></i>
            </div>
            <div id="auth-message"></div>
            <div class="auth-buttons">
                <button class="custom-btn" onclick="handleLogin()">Entrar</button>
                <button class="custom-btn secondary" onclick="handleRegister()">Registrar</button>
            </div>
        </div>
    </div>

    <div id="app-container">
        <header class="header">
            <i class="fas fa-bars menu-icon" onclick="openMenu()"></i>
            <div class="title">
                <img src="01.png" alt="Logo" />
                Meu Mercado
            </div>
            <div class="header-right">
                <span id="username-display"></span>
                <div id="sync-status-indicator" class="status-saved" title="Status de Sincronização"></div>
            </div>
        </header>

        <main class="container">
            <section id="list-section" class="section shopping-list-section">
                <div class="section-header">
                    <h2>Lista de Compras</h2>
                    <button class="clear-btn" onclick="clearList()">Limpar Lista <i class="fas fa-trash"></i></button>
                </div>
                <div class="table-scroll-wrapper">
                    <table class="shopping-list-table">
                        <thead>
                            <tr>
                                <th style="width: 20px;"></th> <th style="width: 40%;">Item</th>
                                <th style="width: 80px;">Preço A</th>
                                <th style="width: 80px;">Preço B</th>
                                <th style="width: 80px;">Preço C</th>
                                <th style="width: 20px;"></th> </tr>
                        </thead>
                        <tbody id="shopping-list-body">
                            </tbody>
                        <tfoot id="shopping-list-footer">
                            <tr>
                                <td></td>
                                <td>
                                    <input type="text" id="new-item-name" class="item-name-input" placeholder="Adicionar novo item..." onkeypress="handleNewItemKeypress(event)" />
                                    <div id="autocomplete-suggestions"></div>
                                </td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td><button class="action-btn add" onclick="addNewItem()"><i class="fas fa-plus-circle"></i></button></td>
                            </tr>
                            <tr>
                                <td colspan="2" style="font-weight: bold;">TOTAL ESTIMADO</td>
                                <td id="total-price-a" style="text-align: right; font-weight: bold;">R$ 0,00</td>
                                <td id="total-price-b" style="text-align: right; font-weight: bold;">R$ 0,00</td>
                                <td id="total-price-c" style="text-align: right; font-weight: bold;">R$ 0,00</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </section>

            <section id="comparator-section" class="section" style="display: none;">
                <div class="collapsible-header" onclick="toggleCollapsible('comparator-content')">
                    <h2>Comparador de Preços</h2>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div id="comparator-content" class="collapsible-content">
                    <div class="iframe-container">
                        <div id="iframe-overlay">
                            <div class="loader"></div>
                            <p>Carregando ferramenta de comparação...</p>
                        </div>
                        <iframe id="price-comparator-iframe" src="about:blank" allowfullscreen></iframe>
                    </div>
                </div>
            </section>

            <section id="config-section" class="section" style="display: none;">
                <div class="section-header">
                    <h2>Configurações</h2>
                </div>
                <p>Configurações da aplicação virão aqui.</p>
                <div class="button-group">
                    <button class="custom-btn danger" onclick="confirmDeleteAccount()">Excluir Conta</button>
                    <button class="custom-btn secondary" onclick="handleLogout()">Sair da Conta</button>
                </div>
            </section>
        </main>

        <footer class="footer">
            <p>&copy; 2024 Meu Mercado. Sua lista de compras inteligente.</p>
        </footer>
    </div>

    <script>
        // Variáveis globais
        let shoppingList = [];
        let isOnline = navigator.onLine;

        // Funções de Utilidade
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        }

        // Funções de Estado e UI
        function showApp() {
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';
        }

        function showAuth() {
            document.getElementById('app-container').style.display = 'none';
            document.getElementById('auth-container').style.display = 'flex';
        }

        function openMenu() {
            document.getElementById("side-menu").classList.add("open");
            document.getElementById("page-overlay").classList.add("show");
        }

        function closeMenu() {
            document.getElementById("side-menu").classList.remove("open");
            document.getElementById("page-overlay").classList.remove("show");
        }

        function showSection(section) {
            closeMenu();
            document.getElementById('list-section').style.display = 'block';
            document.getElementById('comparator-section').style.display = 'none';
            document.getElementById('config-section').style.display = 'none';
            
            if (section === 'comparator') {
                document.getElementById('comparator-section').style.display = 'block';
                // Carrega o iframe apenas quando a seção é exibida
                const iframe = document.getElementById('price-comparator-iframe');
                if (iframe.src === 'about:blank') {
                    document.getElementById('iframe-overlay').style.display = 'flex';
                    iframe.onload = () => {
                        document.getElementById('iframe-overlay').style.display = 'none';
                    };
                    iframe.src = 'https://meumercado.pages.dev/comparator-embed.html'; // Substitua pelo URL real do seu comparador
                }
            } else if (section === 'config') {
                document.getElementById('list-section').style.display = 'none';
                document.getElementById('config-section').style.display = 'block';
            } else {
                 // Certifica-se de que a lista esteja visível por padrão
            }
        }

        function toggleCollapsible(id) {
            const content = document.getElementById(id);
            const header = content.previousElementSibling;
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                content.style.maxHeight = '0';
                header.classList.remove('active');
            } else {
                content.classList.add('expanded');
                content.style.maxHeight = content.scrollHeight + 'px';
                header.classList.add('active');
            }
        }

        // Funções da Lista de Compras
        function calculateTotals() {
            let totalA = 0;
            let totalB = 0;
            let totalC = 0;

            shoppingList.forEach(item => {
                const priceA = parseFloat(item.priceA || 0);
                const priceB = parseFloat(item.priceB || 0);
                const priceC = parseFloat(item.priceC || 0);

                totalA += priceA;
                totalB += priceB;
                totalC += priceC;
            });

            document.getElementById('total-price-a').textContent = formatCurrency(totalA);
            document.getElementById('total-price-b').textContent = formatCurrency(totalB);
            document.getElementById('total-price-c').textContent = formatCurrency(totalC);
        }

        function getCheapestPrice(item) {
            const prices = [
                { price: parseFloat(item.priceA || 0), market: 'A' },
                { price: parseFloat(item.priceB || 0), market: 'B' },
                { price: parseFloat(item.priceC || 0), market: 'C' }
            ].filter(p => p.price > 0);

            if (prices.length === 0) return null;

            // Encontra o menor preço
            const minPrice = Math.min(...prices.map(p => p.price));
            
            // Filtra todos os preços que são iguais ao menor preço
            const cheapestMarkets = prices.filter(p => p.price === minPrice).map(p => p.market);
            
            return { minPrice, cheapestMarkets };
        }

        function renderList() {
            const tbody = document.getElementById('shopping-list-body');
            tbody.innerHTML = ''; // Limpa a lista atual

            shoppingList.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.className = item.purchased ? 'purchased' : '';
                tr.dataset.id = item.id;

                const cheapest = getCheapestPrice(item);

                tr.innerHTML = `
                    <td>
                        <input type="checkbox" ${item.purchased ? 'checked' : ''} onclick="togglePurchased('${item.id}', this.checked)">
                    </td>
                    <td>
                        <textarea 
                            class="item-name-input" 
                            rows="1" 
                            data-id="${item.id}"
                            oninput="autoExpand(this); updateItemName(this.dataset.id, this.value)"
                            onblur="saveToStorage(); hideSuggestions()"
                            onfocus="handleItemInputFocus(this)"
                            >${item.name}</textarea>
                    </td>
                    <td class="price-cell">
                        <input 
                            type="text" 
                            value="${item.priceA || ''}" 
                            placeholder="0,00"
                            class="${(cheapest && cheapest.cheapestMarkets.includes('A')) ? 'cheapest-price' : (item.priceA === '0.00' ? 'default-price' : '')}"
                            oninput="updateItemPrice('${item.id}', 'A', this.value)" 
                            onblur="saveToStorage()"
                            pattern="[0-9]*" 
                            inputmode="decimal"
                        >
                    </td>
                    <td class="price-cell">
                        <input 
                            type="text" 
                            value="${item.priceB || ''}" 
                            placeholder="0,00"
                            class="${(cheapest && cheapest.cheapestMarkets.includes('B')) ? 'cheapest-price' : (item.priceB === '0.00' ? 'default-price' : '')}"
                            oninput="updateItemPrice('${item.id}', 'B', this.value)" 
                            onblur="saveToStorage()"
                            pattern="[0-9]*" 
                            inputmode="decimal"
                        >
                    </td>
                    <td class="price-cell">
                        <input 
                            type="text" 
                            value="${item.priceC || ''}" 
                            placeholder="0,00"
                            class="${(cheapest && cheapest.cheapestMarkets.includes('C')) ? 'cheapest-price' : (item.priceC === '0.00' ? 'default-price' : '')}"
                            oninput="updateItemPrice('${item.id}', 'C', this.value)" 
                            onblur="saveToStorage()"
                            pattern="[0-9]*" 
                            inputmode="decimal"
                        >
                    </td>
                    <td>
                        <button class="action-btn" onclick="deleteItem('${item.id}')"><i class="fas fa-times-circle"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);

                // Auto-expandir o textarea após renderização
                const textarea = tr.querySelector('.item-name-input');
                if (textarea) autoExpand(textarea);
            });

            calculateTotals();
        }

        function autoExpand(field) {
            field.style.height = 'auto';
            field.style.height = (field.scrollHeight) + 'px';
        }

        function updateItemName(id, newName) {
            const item = shoppingList.find(item => item.id === id);
            if (item) {
                item.name = newName;
            }
        }

        function updateItemPrice(id, market, newValue) {
            const item = shoppingList.find(item => item.id === id);
            // Remove R$ e substitui vírgula por ponto para cálculo
            const cleanedValue = newValue.replace('R$', '').replace(',', '.').trim();
            
            // Garante que o valor seja numérico ou vazio
            const numericValue = /^\d*\.?\d*$/.test(cleanedValue) ? cleanedValue : '';

            if (item) {
                item['price' + market] = numericValue;
                renderList(); // Renderiza para atualizar os totais e destaques
            }
        }

        function togglePurchased(id, isChecked) {
            const item = shoppingList.find(item => item.id === id);
            if (item) {
                item.purchased = isChecked;
                saveToStorage();
                renderList(); // Renderiza para aplicar o risco
            }
        }

        function addNewItem() {
            const newItemNameInput = document.getElementById('new-item-name');
            const name = newItemNameInput.value.trim();

            if (name) {
                const newItem = {
                    id: Date.now().toString(),
                    name: name,
                    priceA: '',
                    priceB: '',
                    priceC: '',
                    purchased: false
                };
                shoppingList.unshift(newItem); // Adiciona no início da lista
                saveToStorage();
                newItemNameInput.value = '';
                renderList();
                hideSuggestions(); // Oculta sugestões após adicionar
            }
        }

        function handleNewItemKeypress(event) {
            if (event.key === 'Enter') {
                event.preventDefault(); // Impede quebra de linha
                addNewItem();
            }
        }

        function deleteItem(id) {
            shoppingList = shoppingList.filter(item => item.id !== id);
            saveToStorage();
            renderList();
        }

        function clearList() {
            if (confirm("Tem certeza de que deseja limpar a lista de compras?")) {
                shoppingList = [];
                saveToStorage();
                renderList();
            }
        }

        // Funções de Autenticação
        function handleLogin() {
            // Lógica de login simples para demonstração
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const authMessage = document.getElementById('auth-message');

            if (email && password) {
                // Simulação de autenticação bem-sucedida
                localStorage.setItem('authToken', 'fake-token');
                localStorage.setItem('username', email.split('@')[0]);
                document.getElementById('username-display').textContent = localStorage.getItem('username');
                showApp();
            } else {
                authMessage.textContent = "Preencha e-mail e senha.";
            }
        }

        function handleRegister() {
            // Simulação de registro bem-sucedido
            document.getElementById('auth-message').textContent = "Registro simulado. Use suas credenciais para Entrar.";
        }

        function handleLogout() {
            if (confirm("Tem certeza de que deseja sair?")) {
                localStorage.removeItem('authToken');
                localStorage.removeItem('username');
                showAuth();
            }
        }

        function confirmDeleteAccount() {
            if (confirm("ATENÇÃO: Você tem certeza que deseja EXCLUIR sua conta e todos os seus dados? Esta ação é irreversível.")) {
                // Lógica de exclusão de conta simulada
                localStorage.clear();
                alert("Conta excluída (simulação).");
                showAuth();
            }
        }

        document.getElementById('togglePassword').addEventListener('click', function (e) {
            const passwordInput = document.getElementById('password');
            // Alterna o tipo do input entre 'password' e 'text'
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            // Alterna o ícone do olho
            this.classList.toggle('fa-eye-slash');
        });

        // Funções de Sincronização e Armazenamento
        function saveToStorage() {
            localStorage.setItem('shoppingList', JSON.stringify(shoppingList));
            setSyncStatus('syncing');
            // Simulação de sincronização com atraso de 1 segundo
            setTimeout(() => {
                setSyncStatus(isOnline ? 'saved' : 'offline');
            }, 1000);
        }

        async function carregarItens() {
            const storedList = localStorage.getItem('shoppingList');
            if (storedList) {
                shoppingList = JSON.parse(storedList);
            } else {
                // Lista de demonstração inicial, se vazia
                shoppingList = [
                    { id: '1', name: 'Leite Integral (1L)', priceA: '5.50', priceB: '5.99', priceC: '5.20', purchased: false },
                    { id: '2', name: 'Pão de Forma (500g)', priceA: '7.00', priceB: '6.50', priceC: '7.50', purchased: false }
                ];
                saveToStorage();
            }
            document.getElementById('username-display').textContent = localStorage.getItem('username') || 'Usuário';
            renderList();
        }

        function setSyncStatus(status) {
            const indicator = document.getElementById('sync-status-indicator');
            indicator.className = '';
            indicator.classList.add('status-' + status);
            let title;
            switch(status) {
                case 'saved': title = 'Salvo (Online)'; break;
                case 'syncing': title = 'Sincronizando...'; break;
                case 'error': title = 'Erro de Sincronização'; break;
                case 'offline': title = 'Modo Offline'; break;
                default: title = 'Status Desconhecido';
            }
            indicator.title = title;
        }

        window.addEventListener('online', () => { isOnline = true; setSyncStatus('saved'); saveToStorage(); });
        window.addEventListener('offline', () => { isOnline = false; setSyncStatus('offline'); });

        // --- Autocomplete Simples ---
        const allItemNames = ["Leite", "Pão", "Arroz", "Feijão", "Açúcar", "Café", "Manteiga", "Ovos", "Frango", "Carne", "Legumes", "Frutas", "Queijo", "Macarrão", "Óleo", "Sabão", "Shampoo", "Cerveja", "Refrigerante"];
        
        function showSuggestions(inputElement) {
            const query = inputElement.value.toLowerCase();
            const suggestionsContainer = document.getElementById('autocomplete-suggestions');
            
            if (query.length < 2) {
                suggestionsContainer.style.display = 'none';
                return;
            }

            const filteredSuggestions = allItemNames.filter(name => name.toLowerCase().includes(query) && !shoppingList.some(item => item.name.toLowerCase() === name.toLowerCase()));
            
            suggestionsContainer.innerHTML = '';
            
            if (filteredSuggestions.length > 0) {
                filteredSuggestions.forEach(suggestion => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    div.textContent = suggestion;
                    div.onclick = () => {
                        inputElement.value = suggestion;
                        addNewItem(); // Adiciona o item sugerido
                        hideSuggestions();
                    };
                    suggestionsContainer.appendChild(div);
                });

                // Posiciona e exibe
                const rect = inputElement.getBoundingClientRect();
                suggestionsContainer.style.width = rect.width + 'px';
                suggestionsContainer.style.top = rect.bottom + window.scrollY + 'px';
                suggestionsContainer.style.left = rect.left + window.scrollX + 'px';
                suggestionsContainer.style.display = 'block';
            } else {
                hideSuggestions();
            }
        }

        function hideSuggestions() {
            document.getElementById('autocomplete-suggestions').style.display = 'none';
        }

        function handleItemInputFocus(inputElement) {
             // Esconde as sugestões ao focar para edição em itens existentes
             hideSuggestions();
        }

        // Listener para o campo de nova lista
        document.getElementById('new-item-name').addEventListener('input', function() {
            showSuggestions(this);
        });
        
        // Listener para fechar as sugestões ao clicar fora
        document.addEventListener('click', function(e) {
            const suggestionsContainer = document.getElementById('autocomplete-suggestions');
            const newItemInput = document.getElementById('new-item-name');
            if (suggestionsContainer && !suggestionsContainer.contains(e.target) && e.target !== newItemInput) {
                hideSuggestions();
            }
        });

        // --- CORREÇÃO DE TECLADO VIRTUAL EM PWA (para iOS e Android) ---
        function setupVirtualKeyboardListener() {
            if (!window.visualViewport) return;

            const isLikelyKeyboardOpen = () => window.visualViewport.height < document.documentElement.clientHeight - 150;
            let keyboardWasOpen = isLikelyKeyboardOpen();
            window.visualViewport.addEventListener('resize', () => {
                const keyboardIsOpen = isLikelyKeyboardOpen();
                if (keyboardWasOpen && !keyboardIsOpen) {
                    if (document.activeElement && ['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) {
                         document.activeElement.blur();
                    }
                }
                keyboardWasOpen = keyboardIsOpen;
            });
        }

        // --- INICIALIZAÇÃO DA APLICAÇÃO ---
        document.addEventListener('DOMContentLoaded', async () => {
            await carregarItens();
            
            if (localStorage.getItem('authToken')) {
                showApp();
            } else {
                showAuth();
            }
            setupVirtualKeyboardListener();
            setSyncStatus(isOnline ? 'saved' : 'offline');
        });
        
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(registration => {
                console.log('ServiceWorker registrado com sucesso: ', registration.scope);
                })
                .catch(error => {
                console.log('Falha ao registrar o ServiceWorker: ', error);
                });
            });
        }
    </script>
</body>
</html>
